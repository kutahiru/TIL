# 環境構築

npx create-next-app@latestが真っ新な環境での実行を想定しているみたいだから
Dockerファイル等を作成する前に実行する。

```bash
docker compose run --rm app npx create-next-app@latest

✔ What is your project named? … my-app
✔ Would you like to use TypeScript? … Yes
✔ Which linter would you like to use? › ESLint
✔ Would you like to use Tailwind CSS? … Yes
✔ Would you like your code inside a `src/` directory? … Yes
✔ Would you like to use App Router? (recommended) … Yes
✔ Would you like to use Turbopack? (recommended) … Yes
✔ Would you like to customize the import alias (`@/*` by default)? … No
Creating a new Next.js app in /app/my-app.
```

```bash
touch Dockerfile compose.yml
```

```
# Dockerfile
FROM node:22
ENV LANG=C.UTF-8
ENV TZ=Asia/Tokyo

WORKDIR /app

COPY . /app
```

```yml
# compose.yml
services:
  db:
    image: postgres
    restart: always
    environment:
      TZ: Asia/Tokyo
      POSTGRES_DB: myapp_development
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    ports:
      - 5432:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d myapp_development -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
  app:
    build: .
    ports:
      - "3000:3000"
    volumes:
      - .:/app
    environment:
      - CHOKIDAR_USEPOLLING=true    # ファイル変更をポーリングで監視
      - WATCHPACK_POLLING=true      # Webpack/Turbopackのポーリング有効
      # ⚡ Next.js 15最適化
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      - TURBOPACK=1
      - DATABASE_URL=postgresql://postgres:password@db:5432/myapp_development
    depends_on:
      db:
        condition: service_healthy  # DBの起動完了を待つ
    command: bash -c "npm install && npm run dev -- --hostname 0.0.0.0" # docker compose upで実行される
volumes:
  postgresql_data:
```

```bash
docker compose build
```

```bash
docker compose up
```

```json
// .devcontainer/devcontainer.json
{
  "name": "Next.js 15 Development",
  "dockerComposeFile": "../compose.yml",
  "service": "app",
  "workspaceFolder": "/app",
  "shutdownAction": "stopCompose",
  "features": {
    "ghcr.io/anthropics/devcontainer-features/claude-code:1.0": {}
  },
  "customizations": {
    "vscode": {
      "extensions": [
        "ms-vscode.vscode-typescript-next",
        "bradlc.vscode-tailwindcss",
        "esbenp.prettier-vscode",
        "dbaeumer.vscode-eslint",
        "formulahendry.auto-rename-tag",
        "christian-kohler.path-intellisense",
        "ms-vscode.vscode-json",
        "streetsidesoftware.code-spell-checker",
        "yoavbls.pretty-ts-errors"
      ],
      "settings": {
        "terminal.integrated.defaultProfile.linux": "sh",
        "typescript.preferences.importModuleSpecifier": "relative"
      }
    }
  },
  "forwardPorts": [3000, 5432],
  "portsAttributes": {
    "3000": {
      "label": "Next.js App",
      "onAutoForward": "notify"
    },
    "5432": {
      "label": "PostgreSQL",
      "onAutoForward": "silent"
    }
  },
  "postCreateCommand": "npm install",
  "remoteUser": "root"
}
```

```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Next.js: debug server-side",
      "type": "node",
      "request": "attach",
      "port": 9229,
      "skipFiles": ["<node_internals>/**"]
    },
    {
      "name": "Next.js: debug client-side",
      "type": "chrome",
      "request": "launch",
      "url": "http://localhost:3000",
      "webRoot": "${workspaceFolder}"
    },
    {
      "name": "Next.js: debug full stack",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/node_modules/.bin/next",
      "args": ["dev"],
      "console": "integratedTerminal",
      "serverReadyAction": {
        "pattern": "started server on .+, url: (https?://.+)",
        "uriFormat": "%s",
        "action": "debugWithChrome"
      }
    }
  ]
}
```

## ClaudeCodeの注意点

認証時に自動で飛ばされるリンクはだめで、
コンソールに表示されているリンクを手動でコピーすると、
キーが表示される。

